2025-02-07 00:02:37.364 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 45
2025-02-07 00:02:37.380 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:02:37.383 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:02:37.474 +03:00 [INF] Executed DbCommand (79ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:02:37.488 +03:00 [INF] Executed DbCommand (4ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:02:37.495 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:02:37.499 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 111.5643ms
2025-02-07 00:02:37.502 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:02:37.503 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 139.4639ms
2025-02-07 00:02:38.251 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 39
2025-02-07 00:02:38.266 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:02:38.269 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:02:38.274 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:02:38.277 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:02:38.287 +03:00 [INF] Executed DbCommand (4ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.297 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.302 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.305 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.308 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.313 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.317 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.327 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.330 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.335 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.344 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.355 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.358 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.362 +03:00 [INF] Executed DbCommand (2ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.374 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.381 +03:00 [INF] Executed DbCommand (4ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.392 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.400 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.404 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.407 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.410 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:02:38.419 +03:00 [INF] Executed DbCommand (6ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = DateTime2), @p2='?' (Size = 4000), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (Size = 450), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [AuthLogs] ([AuthType], [CreatedAt], [DeviceId], [FailureReason], [IpAddress], [NationalId], [Status], [UserAgent])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-02-07 00:02:38.423 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'NayifatAPI.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:6e69ecfb-d1ee-48ac-a7fc-54391dc51b7a
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:6e69ecfb-d1ee-48ac-a7fc-54391dc51b7a
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-02-07 00:02:38.437 +03:00 [ERR] Error logging audit event. NationalId: all, Action: notification_delivered, Details: {"notification_count":21,"notification_ids":[38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,23,20,19,18,12],"timestamp":"2025-02-07T00:02:38.2830357"}
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:6e69ecfb-d1ee-48ac-a7fc-54391dc51b7a
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at NayifatAPI.Services.AuditLogService.LogAsync(String nationalId, String action, Object details) in C:\Users\yamta\StudioProjects\nayifat_app_2025_new\NayifatAPI\Services\AuditLogService.cs:line 36
2025-02-07 00:02:38.455 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:02:38.457 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 184.7524ms
2025-02-07 00:02:38.459 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:02:38.460 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 208.7844ms
2025-02-07 00:07:37.570 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 45
2025-02-07 00:07:37.577 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:07:37.579 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:07:37.599 +03:00 [INF] Executed DbCommand (5ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:07:37.607 +03:00 [INF] Executed DbCommand (3ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:07:37.612 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:07:37.614 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 31.0723ms
2025-02-07 00:07:37.618 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:07:37.620 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 50.2347ms
2025-02-07 00:07:38.276 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 39
2025-02-07 00:07:38.281 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:07:38.283 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:07:38.288 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:07:38.293 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:07:38.304 +03:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.310 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.315 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.320 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.327 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.332 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.336 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.340 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.345 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.350 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.354 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.357 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.360 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.364 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.367 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.370 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.373 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.375 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.379 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.383 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.387 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:07:38.395 +03:00 [INF] Executed DbCommand (4ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = DateTime2), @p2='?' (Size = 4000), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (Size = 450), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [AuthLogs] ([AuthType], [CreatedAt], [DeviceId], [FailureReason], [IpAddress], [NationalId], [Status], [UserAgent])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-02-07 00:07:38.400 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'NayifatAPI.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:cec96591-860f-4633-8169-fca4bde25677
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:cec96591-860f-4633-8169-fca4bde25677
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-02-07 00:07:38.415 +03:00 [ERR] Error logging audit event. NationalId: all, Action: notification_delivered, Details: {"notification_count":21,"notification_ids":[38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,23,20,19,18,12],"timestamp":"2025-02-07T00:07:38.3007919"}
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:cec96591-860f-4633-8169-fca4bde25677
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at NayifatAPI.Services.AuditLogService.LogAsync(String nationalId, String action, Object details) in C:\Users\yamta\StudioProjects\nayifat_app_2025_new\NayifatAPI\Services\AuditLogService.cs:line 36
2025-02-07 00:07:38.425 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:07:38.426 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 140.3535ms
2025-02-07 00:07:38.428 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:07:38.429 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 153.3084ms
2025-02-07 00:12:37.661 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 45
2025-02-07 00:12:37.665 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:12:37.667 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:12:37.684 +03:00 [INF] Executed DbCommand (5ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:12:37.691 +03:00 [INF] Executed DbCommand (3ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:12:37.695 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:12:37.697 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 25.9647ms
2025-02-07 00:12:37.698 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:12:37.700 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 38.9804ms
2025-02-07 00:12:38.401 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 39
2025-02-07 00:12:38.404 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:12:38.405 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:12:38.408 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:12:38.413 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:12:38.422 +03:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.427 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.432 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.437 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.441 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.445 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.448 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.452 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.457 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.460 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.465 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.469 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.473 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.478 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.481 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.486 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.490 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.494 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.498 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.502 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.505 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:12:38.516 +03:00 [INF] Executed DbCommand (9ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = DateTime2), @p2='?' (Size = 4000), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (Size = 450), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [AuthLogs] ([AuthType], [CreatedAt], [DeviceId], [FailureReason], [IpAddress], [NationalId], [Status], [UserAgent])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-02-07 00:12:38.521 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'NayifatAPI.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:e51ee3bb-25c7-4222-8d17-723194ecbf3b
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:e51ee3bb-25c7-4222-8d17-723194ecbf3b
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-02-07 00:12:38.540 +03:00 [ERR] Error logging audit event. NationalId: all, Action: notification_delivered, Details: {"notification_count":21,"notification_ids":[38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,23,20,19,18,12],"timestamp":"2025-02-07T00:12:38.419678"}
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:e51ee3bb-25c7-4222-8d17-723194ecbf3b
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at NayifatAPI.Services.AuditLogService.LogAsync(String nationalId, String action, Object details) in C:\Users\yamta\StudioProjects\nayifat_app_2025_new\NayifatAPI\Services\AuditLogService.cs:line 36
2025-02-07 00:12:38.553 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:12:38.554 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 147.1204ms
2025-02-07 00:12:38.555 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:12:38.557 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 156.1552ms
2025-02-07 00:17:37.302 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 45
2025-02-07 00:17:37.309 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:17:37.310 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:17:37.314 +03:00 [INF] Executed DbCommand (2ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:17:37.318 +03:00 [INF] Executed DbCommand (2ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:17:37.321 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:17:37.324 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 13.0083ms
2025-02-07 00:17:37.326 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:17:37.328 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 26.0474ms
2025-02-07 00:17:38.060 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 39
2025-02-07 00:17:38.066 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:17:38.069 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:17:38.076 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:17:38.084 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:17:38.095 +03:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.101 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.107 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.112 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.117 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.122 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.129 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.135 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.141 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.148 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.153 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.157 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.162 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.167 +03:00 [INF] Executed DbCommand (2ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.171 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.175 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.179 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.182 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.185 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.190 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.194 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:17:38.201 +03:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = DateTime2), @p2='?' (Size = 4000), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (Size = 450), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [AuthLogs] ([AuthType], [CreatedAt], [DeviceId], [FailureReason], [IpAddress], [NationalId], [Status], [UserAgent])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-02-07 00:17:38.203 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'NayifatAPI.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:e51ee3bb-25c7-4222-8d17-723194ecbf3b
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:e51ee3bb-25c7-4222-8d17-723194ecbf3b
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-02-07 00:17:38.218 +03:00 [ERR] Error logging audit event. NationalId: all, Action: notification_delivered, Details: {"notification_count":21,"notification_ids":[38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,23,20,19,18,12],"timestamp":"2025-02-07T00:17:38.0917704"}
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:e51ee3bb-25c7-4222-8d17-723194ecbf3b
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at NayifatAPI.Services.AuditLogService.LogAsync(String nationalId, String action, Object details) in C:\Users\yamta\StudioProjects\nayifat_app_2025_new\NayifatAPI\Services\AuditLogService.cs:line 36
2025-02-07 00:17:38.228 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:17:38.229 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 155.1335ms
2025-02-07 00:17:38.231 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:17:38.232 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 172.8837ms
2025-02-07 00:22:37.489 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 45
2025-02-07 00:22:37.494 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:22:37.496 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:22:37.516 +03:00 [INF] Executed DbCommand (4ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:22:37.525 +03:00 [INF] Executed DbCommand (3ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:22:37.531 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:22:37.533 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 32.873ms
2025-02-07 00:22:37.537 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:22:37.539 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 50.2102ms
2025-02-07 00:22:38.281 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 39
2025-02-07 00:22:38.287 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:22:38.288 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 00:22:38.294 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 00:22:38.299 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 00:22:38.309 +03:00 [INF] Executed DbCommand (3ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.316 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.321 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.326 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.331 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.338 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.341 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.345 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.348 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.353 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.356 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.361 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.367 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.371 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.374 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.378 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.381 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.384 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.386 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.390 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.393 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 00:22:38.400 +03:00 [INF] Executed DbCommand (5ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = DateTime2), @p2='?' (Size = 4000), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (Size = 450), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [AuthLogs] ([AuthType], [CreatedAt], [DeviceId], [FailureReason], [IpAddress], [NationalId], [Status], [UserAgent])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-02-07 00:22:38.404 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'NayifatAPI.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:50b04506-a3ff-40b0-9873-6053c24697be
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:50b04506-a3ff-40b0-9873-6053c24697be
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-02-07 00:22:38.416 +03:00 [ERR] Error logging audit event. NationalId: all, Action: notification_delivered, Details: {"notification_count":21,"notification_ids":[38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,23,20,19,18,12],"timestamp":"2025-02-07T00:22:38.3062592"}
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:50b04506-a3ff-40b0-9873-6053c24697be
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at NayifatAPI.Services.AuditLogService.LogAsync(String nationalId, String action, Object details) in C:\Users\yamta\StudioProjects\nayifat_app_2025_new\NayifatAPI\Services\AuditLogService.cs:line 36
2025-02-07 00:22:38.430 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 00:22:38.433 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 140.5015ms
2025-02-07 00:22:38.435 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 00:22:38.436 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 155.3025ms
2025-02-07 04:15:31.349 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 45
2025-02-07 04:15:31.353 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 04:15:31.354 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 04:15:31.470 +03:00 [INF] Executed DbCommand (98ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 04:15:31.492 +03:00 [INF] Executed DbCommand (14ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 04:15:31.497 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 04:15:31.500 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 140.2539ms
2025-02-07 04:15:31.503 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 04:15:31.507 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 157.9656ms
2025-02-07 04:15:32.570 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 39
2025-02-07 04:15:32.576 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 04:15:32.578 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 04:15:32.586 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 04:15:32.595 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 04:15:32.615 +03:00 [INF] Executed DbCommand (12ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.620 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.625 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.630 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.635 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.638 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.642 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.652 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.660 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.667 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.675 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.681 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.687 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.693 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.699 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.704 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.709 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.715 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.720 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.724 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.728 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 04:15:32.747 +03:00 [INF] Executed DbCommand (16ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = DateTime2), @p2='?' (Size = 4000), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (Size = 450), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [AuthLogs] ([AuthType], [CreatedAt], [DeviceId], [FailureReason], [IpAddress], [NationalId], [Status], [UserAgent])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-02-07 04:15:32.751 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'NayifatAPI.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:55dc8099-2c32-4819-a005-2dcb39f144b5
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:55dc8099-2c32-4819-a005-2dcb39f144b5
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-02-07 04:15:32.775 +03:00 [ERR] Error logging audit event. NationalId: all, Action: notification_delivered, Details: {"notification_count":21,"notification_ids":[38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,23,20,19,18,12],"timestamp":"2025-02-07T04:15:32.6029128"}
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:55dc8099-2c32-4819-a005-2dcb39f144b5
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at NayifatAPI.Services.AuditLogService.LogAsync(String nationalId, String action, Object details) in C:\Users\yamta\StudioProjects\nayifat_app_2025_new\NayifatAPI\Services\AuditLogService.cs:line 36
2025-02-07 04:15:32.789 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 04:15:32.791 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 207.0342ms
2025-02-07 04:15:32.794 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 04:15:32.795 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 225.0468ms
2025-02-07 05:48:39.326 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 45
2025-02-07 05:48:39.330 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 05:48:39.331 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 05:48:39.488 +03:00 [INF] Executed DbCommand (136ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 05:48:39.590 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/content/timestamps - application/json; charset=utf-8 2
2025-02-07 05:48:39.593 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.ContentController.GetTimestamps (NayifatAPI)'
2025-02-07 05:48:39.594 +03:00 [INF] Route matched with {action = "GetTimestamps", controller = "Content"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetTimestamps() on controller NayifatAPI.Controllers.ContentController (NayifatAPI).
2025-02-07 05:48:39.595 +03:00 [INF] TTT_
2025-02-07 05:48:39.596 +03:00 [INF] TTT_=== Getting Content Timestamps ===
2025-02-07 05:48:39.600 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 05:48:39.601 +03:00 [INF] TTT_Fetching timestamps from database
2025-02-07 05:48:39.693 +03:00 [INF] Executed DbCommand (201ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 05:48:39.693 +03:00 [INF] Executed DbCommand (91ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT [m].[page] AS [Page], [m].[key_name] AS [KeyName], [m].[last_updated] AS [LastUpdated]
FROM [master_config] AS [m]
2025-02-07 05:48:39.696 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 05:48:39.698 +03:00 [INF] TTT_Found 18 content items
2025-02-07 05:48:39.699 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 366.6123ms
2025-02-07 05:48:39.700 +03:00 [INF] TTT_Page: home
2025-02-07 05:48:39.701 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 05:48:39.701 +03:00 [INF] TTT_  - slideshow_content: "2025-02-05T13:56:06.9430000"
2025-02-07 05:48:39.702 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 375.9792ms
2025-02-07 05:48:39.703 +03:00 [INF] TTT_  - slideshow_content_ar: "2025-02-05T14:22:06.9430000"
2025-02-07 05:48:39.705 +03:00 [INF] TTT_  - contact_details: "2025-02-05T15:43:06.9430000"
2025-02-07 05:48:39.705 +03:00 [INF] TTT_  - contact_details_ar: "2025-02-05T14:06:06.9430000"
2025-02-07 05:48:39.706 +03:00 [INF] TTT_  - termsEN1: "2025-02-03T14:23:58.0000000"
2025-02-07 05:48:39.707 +03:00 [INF] TTT_  - termsEN2: "2025-02-03T14:25:20.1730000"
2025-02-07 05:48:39.707 +03:00 [INF] TTT_  - privacyEN1: "2025-02-03T14:26:08.6130000"
2025-02-07 05:48:39.708 +03:00 [INF] TTT_  - privacyEN2: "2025-02-03T14:25:20.1730000"
2025-02-07 05:48:39.709 +03:00 [INF] TTT_  - termsAR1: "2025-02-03T14:23:58.0000000"
2025-02-07 05:48:39.709 +03:00 [INF] TTT_  - termsAR2: "2025-02-03T14:25:20.1730000"
2025-02-07 05:48:39.710 +03:00 [INF] TTT_  - privacyAR1: "2025-02-03T14:26:08.6130000"
2025-02-07 05:48:39.710 +03:00 [INF] TTT_  - privacyAR2: "2025-02-03T14:25:20.1730000"
2025-02-07 05:48:39.711 +03:00 [INF] TTT_  - terms&conditionsCC_AR: "2025-02-03T17:06:57.7700000"
2025-02-07 05:48:39.711 +03:00 [INF] TTT_  - terms&conditionsCC_EN: "2025-02-03T17:07:47.4900000"
2025-02-07 05:48:39.712 +03:00 [INF] TTT_  - terms&conditionsPF_AR: "2025-02-06T23:06:57.7700000"
2025-02-07 05:48:39.713 +03:00 [INF] TTT_  - terms&conditionsPF_EN: "2025-02-03T17:06:57.7700000"
2025-02-07 05:48:39.713 +03:00 [INF] TTT_Page: loans
2025-02-07 05:48:39.714 +03:00 [INF] TTT_  - loan_ad: "2025-02-05T13:56:06.9430000"
2025-02-07 05:48:39.714 +03:00 [INF] TTT_Page: cards
2025-02-07 05:48:39.715 +03:00 [INF] TTT_  - card_ad: "2025-02-05T15:43:06.9430000"
2025-02-07 05:48:39.716 +03:00 [INF] TTT_Successfully retrieved all timestamps
2025-02-07 05:48:39.717 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 05:48:39.718 +03:00 [INF] Executed action NayifatAPI.Controllers.ContentController.GetTimestamps (NayifatAPI) in 123.0411ms
2025-02-07 05:48:39.719 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.ContentController.GetTimestamps (NayifatAPI)'
2025-02-07 05:48:39.719 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/content/timestamps - 200 null application/json; charset=utf-8 128.9729ms
2025-02-07 05:48:43.142 +03:00 [INF] Request starting HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - application/json; charset=utf-8 39
2025-02-07 05:48:43.147 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 05:48:43.148 +03:00 [INF] Route matched with {action = "GetNotifications", controller = "Notifications"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] GetNotifications(NayifatAPI.Controllers.GetNotificationsRequest) on controller NayifatAPI.Controllers.NotificationsController (NayifatAPI).
2025-02-07 05:48:43.150 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__providedApiKey_0='?' (Size = 255)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [a].[api_Key], [a].[CreatedAt], [a].[Description], [a].[ExpiresAt], [a].[IsActive], [a].[LastUsedAt]
FROM [ApiKeys] AS [a]
WHERE [a].[api_Key] = @__providedApiKey_0 AND [a].[IsActive] = CAST(1 AS bit)
2025-02-07 05:48:43.154 +03:00 [INF] Executed DbCommand (1ms) [Parameters=[@__request_NationalId_0='?' (Size = 450)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[national_id], [u].[last_updated], [u].[notifications]
FROM [user_notifications] AS [u]
WHERE [u].[national_id] = @__request_NationalId_0
2025-02-07 05:48:43.165 +03:00 [INF] Executed DbCommand (8ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.167 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.169 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.171 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.172 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.174 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.176 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.178 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.180 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.183 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.185 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.186 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.188 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.190 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.192 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.194 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.196 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.198 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.200 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.202 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.204 +03:00 [INF] Executed DbCommand (0ms) [Parameters=[@__Parse_0='?' (DbType = Int32)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [n].[Id], [n].[additional_data], [n].[big_picture_url], [n].[Body], [n].[body_ar], [n].[body_en], [n].[created_at], [n].[expiry_at], [n].[large_icon_url], [n].[Route], [n].[target_criteria], [n].[Title], [n].[title_ar], [n].[title_en]
FROM [notification_templates] AS [n]
WHERE [n].[Id] = @__Parse_0
2025-02-07 05:48:43.216 +03:00 [INF] Executed DbCommand (10ms) [Parameters=[@p0='?' (Size = 4000), @p1='?' (DbType = DateTime2), @p2='?' (Size = 4000), @p3='?' (Size = 4000), @p4='?' (Size = 4000), @p5='?' (Size = 450), @p6='?' (Size = 4000), @p7='?' (Size = 4000)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [AuthLogs] ([AuthType], [CreatedAt], [DeviceId], [FailureReason], [IpAddress], [NationalId], [Status], [UserAgent])
OUTPUT INSERTED.[Id]
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7);
2025-02-07 05:48:43.219 +03:00 [ERR] An exception occurred in the database while saving changes for context type 'NayifatAPI.Data.ApplicationDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:7bc110fb-b6b9-461f-816b-f458d3839257
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:7bc110fb-b6b9-461f-816b-f458d3839257
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-02-07 05:48:43.227 +03:00 [ERR] Error logging audit event. NationalId: all, Action: notification_delivered, Details: {"notification_count":21,"notification_ids":[38,37,36,35,34,33,32,31,30,29,28,27,26,25,24,23,23,20,19,18,12],"timestamp":"2025-02-07T05:48:43.1566422"}
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): The INSERT statement conflicted with the FOREIGN KEY constraint "FK_AuthLogs_Customers_NationalId". The conflict occurred in database "NayifatApp", table "dbo.Customers", column 'NationalId'.
   at Microsoft.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at Microsoft.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at Microsoft.Data.SqlClient.SqlDataReader.TryHasMoreRows(Boolean& moreRows)
   at Microsoft.Data.SqlClient.SqlDataReader.TryReadInternal(Boolean setTimeout, Boolean& more)
   at Microsoft.Data.SqlClient.SqlDataReader.ReadAsyncExecute(Task task, Object state)
   at Microsoft.Data.SqlClient.SqlDataReader.InvokeAsyncCall[T](SqlDataReaderBaseAsyncCallContext`1 context)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
ClientConnectionId:7bc110fb-b6b9-461f-816b-f458d3839257
Error Number:547,State:0,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeResultSetAsync(Int32 startCommandIndex, RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.AffectedCountModificationCommandBatch.ConsumeAsync(RelationalDataReader reader, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at NayifatAPI.Services.AuditLogService.LogAsync(String nationalId, String action, Object details) in C:\Users\yamta\StudioProjects\nayifat_app_2025_new\NayifatAPI\Services\AuditLogService.cs:line 36
2025-02-07 05:48:43.234 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType11`2[[System.Boolean, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Object, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 05:48:43.235 +03:00 [INF] Executed action NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI) in 86.2955ms
2025-02-07 05:48:43.236 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.NotificationsController.GetNotifications (NayifatAPI)'
2025-02-07 05:48:43.237 +03:00 [INF] Request finished HTTP/1.1 POST http://cbb7-78-95-59-4.ngrok-free.app/api/notifications/list - 200 null application/json; charset=utf-8 95.2102ms
2025-02-07 05:59:33.978 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/api - null null
2025-02-07 05:59:33.982 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/api - 404 0 null 3.9748ms
2025-02-07 05:59:33.985 +03:00 [INF] Request reached the end of the middleware pipeline without being handled by application code. Request path: GET http://cbb7-78-95-59-4.ngrok-free.app/api, Response status code: 404
2025-02-07 05:59:39.466 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/ - null null
2025-02-07 05:59:39.469 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/ - 301 0 null 2.4617ms
2025-02-07 05:59:39.783 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/index.html - null null
2025-02-07 05:59:39.866 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/index.html - 200 null text/html;charset=utf-8 83.4931ms
2025-02-07 05:59:40.227 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/swagger-ui.css - null null
2025-02-07 05:59:40.270 +03:00 [INF] Sending file. Request path: '/swagger-ui.css'. Physical path: 'N/A'
2025-02-07 05:59:40.272 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/swagger-ui.css - 200 152034 text/css 44.5358ms
2025-02-07 05:59:40.470 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/swagger-ui-standalone-preset.js - null null
2025-02-07 05:59:40.476 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/swagger-ui-bundle.js - null null
2025-02-07 05:59:40.480 +03:00 [INF] Sending file. Request path: '/swagger-ui-standalone-preset.js'. Physical path: 'N/A'
2025-02-07 05:59:40.482 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/swagger-ui-standalone-preset.js - 200 230280 text/javascript 12.3557ms
2025-02-07 05:59:41.169 +03:00 [INF] Sending file. Request path: '/swagger-ui-bundle.js'. Physical path: 'N/A'
2025-02-07 05:59:41.171 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/swagger-ui-bundle.js - 200 1456926 text/javascript 695.1662ms
2025-02-07 05:59:42.158 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/swagger/v1/swagger.json - null null
2025-02-07 05:59:42.182 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/favicon-32x32.png - null null
2025-02-07 05:59:42.184 +03:00 [INF] Sending file. Request path: '/favicon-32x32.png'. Physical path: 'N/A'
2025-02-07 05:59:42.186 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/favicon-32x32.png - 200 628 image/png 4.0599ms
2025-02-07 05:59:42.304 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/swagger/v1/swagger.json - 200 null application/json;charset=utf-8 146.1102ms
2025-02-07 06:00:35.538 +03:00 [INF] Request starting HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/api/Health/database - null null
2025-02-07 06:00:35.543 +03:00 [INF] Executing endpoint 'NayifatAPI.Controllers.HealthController.CheckDatabase (NayifatAPI)'
2025-02-07 06:00:35.551 +03:00 [INF] Route matched with {action = "CheckDatabase", controller = "Health"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] CheckDatabase() on controller NayifatAPI.Controllers.HealthController (NayifatAPI).
2025-02-07 06:00:35.592 +03:00 [INF] Executed DbCommand (16ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT 1
2025-02-07 06:00:35.762 +03:00 [INF] Executed DbCommand (88ms) [Parameters=[], CommandType='"Text"', CommandTimeout='30']
SELECT COUNT(*)
FROM [Customers] AS [c]
2025-02-07 06:00:35.767 +03:00 [INF] Executing OkObjectResult, writing value of type '<>f__AnonymousType28`4[[System.String, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.String, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.Int32, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e],[System.String, System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e]]'.
2025-02-07 06:00:35.771 +03:00 [INF] Executed action NayifatAPI.Controllers.HealthController.CheckDatabase (NayifatAPI) in 218.1573ms
2025-02-07 06:00:35.772 +03:00 [INF] Executed endpoint 'NayifatAPI.Controllers.HealthController.CheckDatabase (NayifatAPI)'
2025-02-07 06:00:35.773 +03:00 [INF] Request finished HTTP/1.1 GET http://cbb7-78-95-59-4.ngrok-free.app/api/Health/database - 200 null application/json; charset=utf-8 235.2953ms
2025-02-07 06:02:46.056 +03:00 [INF] Application is shutting down...
